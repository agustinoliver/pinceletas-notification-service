package ar.edu.utn.frc.tup.tesis.pinceletas_notification_service.events;

import ar.edu.utn.frc.tup.tesis.pinceletas_notification_service.services.AdminService;
import ar.edu.utn.frc.tup.tesis.pinceletas_notification_service.services.NotificacionService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;

import java.util.Arrays;
import java.util.List;

@Component
public class NotificacionEventListener {

    private static final Logger log = LoggerFactory.getLogger(NotificacionEventListener.class);

    private final NotificacionService notificacionService;
    private final AdminService adminService;

    public NotificacionEventListener(NotificacionService notificacionService,
                                     AdminService adminService) {
        this.notificacionService = notificacionService;
        this.adminService = adminService;
    }

    @RabbitListener(queues = "notificaciones.queue")
    public void recibirNotificacion(NotificacionEvent event) {
        log.info("üéØ Evento recibido de RabbitMQ - Tipo: {}, Target: {}", event.getTipo(), event.getTargetRole());
        log.debug("üì¶ Contenido del evento: {}", event);

        try {
            if ("USER".equals(event.getTargetRole()) && event.getUsuarioId() != null) {
                // üî¥ CORREGIDO: Notificaci√≥n para USUARIO espec√≠fico (LOGIN)
                // El usuarioId del evento es el ID del usuario que inici√≥ sesi√≥n
                notificacionService.procesarEventoNotificacion(
                        event.getTitulo(),
                        event.getMensaje(),
                        event.getTipo(),
                        event.getUsuarioId(), // ‚úÖ Usar el usuarioId del evento
                        event.getMetadata()
                );
                log.info("‚úÖ Notificacion USER procesada para usuario: {}", event.getUsuarioId());
            }
            else if ("ADMIN".equals(event.getTargetRole())) {
                // üî¥ CORREGIDO: Notificaci√≥n para ADMIN (NUEVO REGISTRO)
                // El metadata contiene el usuarioId del nuevo usuario registrado
                enviarNotificacionATodosLosAdmins(event);
                log.info("‚úÖ Notificacion ADMIN procesada");
            }
            else {
                log.warn("‚ö†Ô∏è TargetRole no reconocido o usuarioId nulo: {}", event.getTargetRole());
            }
        } catch (Exception e) {
            log.error("‚ùå Error procesando notificacion {}: {}", event.getTipo(), e.getMessage(), e);
        }
    }

    private void enviarNotificacionATodosLosAdmins(NotificacionEvent event) {
        List<Long> adminUserIds = adminService.obtenerIdsDeAdministradores();

        if (adminUserIds.isEmpty()) {
            log.info("üë®‚Äçüíº No hay administradores registrados para enviar notificaci√≥n");
            return;
        }

        log.info("üë®‚Äçüíº Enviando notificaci√≥n a {} administradores", adminUserIds.size());

        for (Long adminId : adminUserIds) {
            // ‚úÖ CORREGIDO: Cada admin recibe la notificaci√≥n con SU propio ID
            notificacionService.procesarEventoNotificacion(
                    event.getTitulo(),
                    event.getMensaje(),
                    event.getTipo(),
                    adminId, // ‚úÖ Usar el ID del admin, no el del usuario registrado
                    event.getMetadata()
            );
        }
    }
}